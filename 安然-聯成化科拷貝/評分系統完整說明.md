# RAG LLM 評分系統完整說明

## 一、系統目標
評估不同資料處理方式對RAG（Retrieval-Augmented Generation）系統效果的影響，找出最佳資料處理實踐。

## 二、四種資料處理方式對比

```
┌─────────────────────┬─────┬──────────┬──────────────┬─────────────┐
│    處理方式          │ OCR │ 人工整理  │ 資料品質      │ 處理成本    │
├─────────────────────┼─────┼──────────┼──────────────┼─────────────┤
│ TEXT_聯成化工        │  ❌  │    ❌     │ 最低         │ 最低        │
│ TEXT_整_聯成化工     │  ❌  │    ✅     │ 中等         │ 中等        │
│ 聯成化工            │  ✅  │    ❌     │ 中低         │ 中等        │
│ 彙整_聯成化工       │  ✅  │    ✅     │ 最高         │ 最高        │
└─────────────────────┴─────┴──────────┴──────────────┴─────────────┘
```

## 三、評分指標詳解

### 3.1 覆蓋率評分（SCORE_1~4）

#### 定義
衡量RAG系統回答中包含多少「應回答之詞彙」的關鍵資訊。

#### 計算方法
```python
# 步驟1：提取關鍵詞
關鍵詞列表 = 分詞處理(應回答之詞彙)

# 步驟2：計算匹配
匹配數 = 0
for 關鍵詞 in 關鍵詞列表:
    if 關鍵詞 in RAG回答:
        匹配數 += 1

# 步驟3：計算覆蓋率
覆蓋率 = (匹配數 / 總關鍵詞數) × 100
```

#### 實例
```
應回答之詞彙：1.申請日期 2.施工轄區 3.包商名稱 4.工作時段
關鍵詞提取：[申請日期, 施工轄區, 包商名稱, 工作時段]（4個）

RAG回答：「填寫申請日期、施工轄區和包商名稱即可」
匹配到：[申請日期, 施工轄區, 包商名稱]（3個）

SCORE = 3/4 × 100 = 75%
```

### 3.2 幻覺檢測（HALLUCINATION_1~4）

#### 定義
檢測RAG系統是否產生原始資料中不存在的虛構內容。

#### 評分等級
| 分數 | 等級 | 說明 | 範例 |
|------|------|------|------|
| 0 | 無幻覺 | 完全依據原文 | 原文：「08:00-17:00」<br>回答：「工作時間為08:00到17:00」 |
| 10 | 極輕微 | 合理解釋 | 回答：「工作時間為早上08:00到下午17:00」 |
| 25 | 輕微 | 少量額外資訊 | 回答：「正常工作時間08:00-17:00，共8小時」 |
| 50 | 中度 | 多個額外內容 | 回答：「工作時間08:00-17:00，午休12:00-13:00」 |
| 100 | 嚴重 | 明顯錯誤 | 回答：「工作時間06:00-18:00，包含加班」 |

#### 檢測邏輯
```python
# 改進版檢測方法
def 幻覺檢測(回答, 參考關鍵詞):
    # 1. 檢查具體數據
    額外數字 = 提取數字(回答) - 提取數字(參考)
    額外日期 = 提取日期(回答) - 提取日期(參考)
    
    # 2. 檢查解釋性詞彙（不過度懲罰）
    解釋詞 = ["因此", "所以", "包括", "例如"]
    
    # 3. 評分
    if len(額外數字) > 2 or len(額外日期) > 1:
        return 50  # 中度幻覺
    elif len(額外數字) > 0:
        return 25  # 輕微幻覺
    elif 包含解釋詞:
        return 10  # 極輕微幻覺
    else:
        return 0   # 無幻覺
```

### 3.3 綜合評分（TOTAL_SCORE_1~4）

#### 定義
平衡覆蓋率和準確性的綜合指標。

#### 計算公式
```
綜合評分 = 覆蓋率 - (幻覺分數 × 權重係數)

其中：
- 原始版權重 = 0.5
- 改進版權重 = 0.3
```

#### 權重選擇理由
- **0.5**：平衡覆蓋率和準確性（適合高風險應用）
- **0.3**：寬容解釋性內容（適合一般商業應用）

## 四、各處理方式的預期表現

### TEXT_聯成化工（原始資料）
- **預期覆蓋率**：40-60%
- **預期幻覺**：較高
- **原因**：資料未經處理，可能有格式問題影響檢索

### TEXT_整_聯成化工（人工整理）
- **預期覆蓋率**：50-70%
- **預期幻覺**：較低
- **原因**：人工整理提升結構化程度，減少歧義

### 聯成化工（OCR處理）
- **預期覆蓋率**：45-65%
- **預期幻覺**：中等
- **原因**：OCR可能引入識別錯誤，影響檢索準確性

### 彙整_聯成化工（OCR+人工整理）
- **預期覆蓋率**：60-80%
- **預期幻覺**：最低
- **原因**：雙重處理確保最佳資料品質

## 五、評估結果解讀指南

### 覆蓋率解讀
```
優秀：80-100% ████████████████████
良好：60-79%  ████████████████
尚可：40-59%  ████████████
需改進：<40%  ████████
```

### 幻覺程度解讀
```
無幻覺：0分     ✅ 理想狀態
可接受：1-25分  ⚠️ 輕微問題
需注意：26-50分 🔶 中度問題
嚴重：>50分     🚫 需立即改善
```

### 綜合評分解讀
```
卓越：80-100分  ⭐⭐⭐⭐⭐
優良：60-79分   ⭐⭐⭐⭐
合格：40-59分   ⭐⭐⭐
待改進：20-39分 ⭐⭐
不及格：<20分   ⭐
```

## 六、實務應用建議

### 1. 成本效益分析
```
如果 (覆蓋率提升 < 10% AND 處理成本 > 2倍):
    維持現有處理方式
否則:
    考慮升級處理方式
```

### 2. 場景化選擇
- **法律/醫療文件**：必須使用「彙整_聯成化工」方式
- **一般商業文件**：「TEXT_整_聯成化工」可能足夠
- **快速原型測試**：「TEXT_聯成化工」快速驗證

### 3. 持續優化策略
1. 定期評估各處理方式的表現
2. 根據評分結果調整資料處理流程
3. 收集使用者反饋校準評分標準
4. 建立處理方式選擇決策樹

## 七、統計指標說明

### 平均覆蓋率
所有測試問題的覆蓋率平均值，反映整體檢索效果。

### 平均幻覺分數
所有測試問題的幻覺分數平均值，反映整體準確性。

### 無幻覺比例
幻覺分數為0的問題佔比，反映完全準確的比例。

### 高覆蓋率比例
覆蓋率≥80%的問題佔比，反映優秀表現的比例。

### 輕微幻覺比例（v2新增）
幻覺分數≤25的問題佔比，反映可接受範圍的比例。