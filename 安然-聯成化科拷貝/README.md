# RAG LLM 評估系統說明文件

## 系統簡介
此系統用於評估 RAG（Retrieval-Augmented Generation）語言模型的回答品質，透過關鍵詞覆蓋率和AI幻覺檢測來量化模型表現。

## 評分標準與計算方法

### 1. 覆蓋率評分 (SCORE_1~4)

**目的**：評估模型回答是否包含應有的關鍵資訊

**計算步驟**：
1. **關鍵詞提取**
   - 從「應回答之詞彙」欄位提取關鍵詞
   - 移除編號格式（如 1., 2. 等）
   - 移除標點符號（：、。、，等）
   - 使用 jieba 中文分詞工具進行斷詞
   - 過濾掉單字詞，保留兩個字以上的詞彙

2. **匹配計算**
   - 檢查每個關鍵詞是否出現在模型回答中
   - 使用不區分大小寫的比對方式
   - 計算公式：`覆蓋率 = (匹配到的關鍵詞數 / 總關鍵詞數) × 100`

**範例**：
```
應回答之詞彙：「1.申請日期 2.施工轄區 3.包商名稱」
提取關鍵詞：[申請日期, 施工轄區, 包商名稱]
模型回答包含：申請日期、施工轄區
覆蓋率 = 2/3 × 100 = 66.67%
```

### 2. AI幻覺檢測評分 (HALLUCINATION_1~4)

**目的**：檢測模型是否產生原文未提及的虛構內容

**評分等級**：
- **0分 - 無幻覺**：完全依據原文，未添加額外資訊
- **25分 - 輕微幻覺**：包含合理推論但未明確標示
- **50分 - 中度幻覺**：添加了原文未提及的具體內容
- **100分 - 嚴重幻覺**：包含明顯錯誤或完全虛構的資訊

**計算方法**：
1. **詞彙比對**
   - 將模型回答進行分詞
   - 計算額外詞彙比例：`(回答詞彙 - 參考詞彙) / 回答總詞彙`

2. **特殊內容檢測**
   - 檢查是否包含原文沒有的具體數字
   - 檢查是否包含原文沒有的日期格式
   - 檢查是否包含原文沒有的專有名詞

3. **幻覺程度判定**
   - 額外詞彙比例 < 20%：無幻覺（0分）
   - 額外詞彙比例 20-40%：輕微幻覺（25分）
   - 額外詞彙比例 40-60%：中度幻覺（50分）
   - 額外詞彙比例 > 60%：嚴重幻覺（100分）

### 3. 綜合評分 (TOTAL_SCORE_1~4)

**計算公式**：
```
綜合評分 = 覆蓋率 - (幻覺分數 × 0.5)
```

**說明**：
- 基礎分數為覆蓋率（0-100分）
- 根據幻覺程度扣分，幻覺分數的50%作為懲罰
- 最低分數為0（使用 clip 函數限制）
- 最高分數為100（無幻覺且完全覆蓋）

**範例計算**：
```
覆蓋率：80%
幻覺分數：25（輕微幻覺）
綜合評分 = 80 - (25 × 0.5) = 80 - 12.5 = 67.5%
```

## 四種資料處理方式

1. **TEXT_聯成化工** (SCORE_1, HALLUCINATION_1)
   - 無OCR處理
   - 無人工整理
   - 原始文字資料

2. **TEXT_整_聯成化工** (SCORE_2, HALLUCINATION_2)
   - 無OCR處理
   - 有人工整理
   - 結構化文字資料

3. **聯成化工** (SCORE_3, HALLUCINATION_3)
   - 有OCR處理
   - 無人工整理
   - OCR識別後的原始資料

4. **彙整_聯成化工** (SCORE_4, HALLUCINATION_4)
   - 有OCR處理
   - 有人工整理
   - 最完整的處理方式

## 評估指標說明

### 統計指標
- **平均覆蓋率**：所有問題的覆蓋率平均值
- **平均幻覺分數**：所有問題的幻覺分數平均值
- **平均綜合評分**：所有問題的綜合評分平均值
- **無幻覺比例**：幻覺分數為0的問題占總問題的百分比
- **高覆蓋率比例**：覆蓋率≥80%的問題占總問題的百分比

### 評估標準建議
- **優秀**：綜合評分 > 80，無幻覺比例 > 90%
- **良好**：綜合評分 60-80，無幻覺比例 > 70%
- **尚可**：綜合評分 40-60，無幻覺比例 > 50%
- **需改進**：綜合評分 < 40 或無幻覺比例 < 50%

## 使用說明

### 環境需求
```bash
pip install pandas numpy jieba xlsxwriter openpyxl streamlit plotly
```

### 執行評估
```bash
# 快速評估
python run_evaluation.py

# 視覺化儀表板
streamlit run streamlit_dashboard.py

# 生成HTML報告
python generate_html_report.py
```

### 輸入檔案格式
Excel檔案需包含以下欄位：
- 序號
- 測試資料
- 測試問題
- 應回答之詞彙
- TEXT_聯成化工
- TEXT_整_聯成化工
- 聯成化工
- 彙整_聯成化工

### 輸出檔案
1. **評估結果Excel**：包含所有評分的詳細資料
2. **HTML報告**：視覺化的評估報告
3. **Streamlit儀表板**：互動式分析介面

## 注意事項

1. **分詞準確性**：評分高度依賴中文分詞的準確性，建議針對專業術語調整分詞字典
2. **關鍵詞權重**：目前所有關鍵詞權重相同，可考慮根據重要性調整
3. **幻覺檢測閾值**：可根據實際需求調整幻覺檢測的嚴格程度
4. **同義詞處理**：目前未處理同義詞，可能導致覆蓋率偏低

## 未來改進方向

1. **語義相似度**：使用詞向量計算語義相似度，而非單純字串匹配
2. **加權評分**：對不同重要性的關鍵詞給予不同權重
3. **上下文理解**：考慮答案的上下文連貫性
4. **多語言支援**：擴展到其他語言的評估
5. **自動化調參**：根據歷史資料自動調整評分參數