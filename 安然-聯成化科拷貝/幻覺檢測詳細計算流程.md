# AI幻覺檢測詳細計算流程與實例

## 一、幻覺檢測的定義

**AI幻覺**：指RAG系統生成的內容中，包含原始資料未提及的虛構、推測或錯誤資訊。

## 二、詳細計算流程

### Step 1：資料預處理

```python
def 預處理(文本):
    # 1. 統一格式
    文本 = 文本.replace("：", ":")
    文本 = 文本.replace("。", " ")
    文本 = 文本.replace("，", " ")
    
    # 2. 移除編號
    文本 = re.sub(r'\d+\.', '', 文本)
    
    return 文本
```

### Step 2：關鍵元素提取

```python
def 提取關鍵元素(文本):
    元素 = {
        "數字": [],
        "日期時間": [],
        "專有名詞": [],
        "一般詞彙": []
    }
    
    # 提取數字
    元素["數字"] = re.findall(r'\b\d+\b', 文本)
    
    # 提取日期時間
    元素["日期時間"] = re.findall(r'\d{4}[-/]\d{1,2}[-/]\d{1,2}|\d{1,2}:\d{2}', 文本)
    
    # 提取專有名詞（使用預定義列表）
    專有名詞列表 = ["工作許可證", "承包商", "施工轄區", "煙火管制區"]
    for 名詞 in 專有名詞列表:
        if 名詞 in 文本:
            元素["專有名詞"].append(名詞)
    
    # 提取一般詞彙（使用jieba分詞）
    詞彙 = jieba.cut(文本)
    元素["一般詞彙"] = [w for w in 詞彙 if len(w) > 1]
    
    return 元素
```

### Step 3：比對分析

```python
def 比對分析(回答元素, 參考元素):
    比對結果 = {
        "額外數字": [],
        "額外日期": [],
        "額外專有名詞": [],
        "解釋性詞彙": 0,
        "額外詞彙比例": 0
    }
    
    # 找出額外的數字
    比對結果["額外數字"] = [
        n for n in 回答元素["數字"] 
        if n not in 參考元素["數字"]
    ]
    
    # 找出額外的日期
    比對結果["額外日期"] = [
        d for d in 回答元素["日期時間"] 
        if d not in 參考元素["日期時間"]
    ]
    
    # 檢查解釋性詞彙
    解釋詞列表 = ["因此", "所以", "包括", "例如", "即", "也就是", "意思是"]
    for 詞 in 解釋詞列表:
        if 詞 in ' '.join(回答元素["一般詞彙"]):
            比對結果["解釋性詞彙"] += 1
    
    # 計算額外詞彙比例
    回答詞彙集 = set(回答元素["一般詞彙"])
    參考詞彙集 = set(參考元素["一般詞彙"])
    額外詞彙 = 回答詞彙集 - 參考詞彙集
    
    if len(回答詞彙集) > 0:
        比對結果["額外詞彙比例"] = len(額外詞彙) / len(回答詞彙集)
    
    return 比對結果
```

### Step 4：幻覺評分

```python
def 計算幻覺分數(比對結果):
    # 評分邏輯（改進版）
    
    # 1. 檢查是否有具體的額外數據
    額外數字數 = len(比對結果["額外數字"])
    額外日期數 = len(比對結果["額外日期"])
    
    # 2. 檢查解釋性內容
    解釋詞數 = 比對結果["解釋性詞彙"]
    
    # 3. 評分判定
    if 額外數字數 > 2 or 額外日期數 > 1:
        分數 = 50
        描述 = "中度幻覺：包含多個未提及的具體數據"
    elif 額外數字數 > 0 or 額外日期數 > 0:
        分數 = 25
        描述 = "輕微幻覺：包含少量額外數據"
    elif 解釋詞數 >= 3:
        分數 = 10
        描述 = "極輕微幻覺：添加合理解釋"
    elif 比對結果["額外詞彙比例"] > 0.6:
        分數 = 100
        描述 = "嚴重幻覺：大量虛構內容"
    else:
        分數 = 0
        描述 = "無幻覺"
    
    return 分數, 描述
```

## 三、完整計算實例

### 實例1：無幻覺（0分）

```
應回答之詞彙：「工作時段為 08:00 ～ 17:00」

RAG回答：「工作時段是08:00到17:00」

計算過程：
1. 提取參考元素：
   - 數字：["08", "00", "17", "00"]
   - 日期時間：["08:00", "17:00"]
   
2. 提取回答元素：
   - 數字：["08", "00", "17", "00"]
   - 日期時間：["08:00", "17:00"]
   
3. 比對結果：
   - 額外數字：[]（無）
   - 額外日期：[]（無）
   - 解釋性詞彙：0
   
4. 幻覺分數：0分（無幻覺）
```

### 實例2：極輕微幻覺（10分）

```
應回答之詞彙：「申請日期、施工轄區、包商名稱」

RAG回答：「申請時需要填寫申請日期，也就是申請當天的日期，
         還有施工轄區，即施工地點所屬的區域，以及包商名稱」

計算過程：
1. 參考元素：
   - 專有名詞：["申請日期", "施工轄區", "包商名稱"]
   
2. 回答元素：
   - 專有名詞：["申請日期", "施工轄區", "包商名稱"]
   - 解釋性詞彙：["也就是", "即"]（2個）
   
3. 比對結果：
   - 額外數字：[]（無）
   - 額外日期：[]（無）
   - 解釋性詞彙：2
   - 新增內容：解釋性說明
   
4. 幻覺分數：10分（極輕微幻覺：添加合理解釋）
```

### 實例3：輕微幻覺（25分）

```
應回答之詞彙：「工作時段 08:00 ～ 17:00」

RAG回答：「正常工作時段為早上8點到下午5點，總共9小時工作時間」

計算過程：
1. 參考元素：
   - 數字：["08", "00", "17", "00"]
   - 日期時間：["08:00", "17:00"]
   
2. 回答元素：
   - 數字：["8", "5", "9"]
   - 額外內容：["9小時"]（原文未提及）
   
3. 比對結果：
   - 額外數字：["9"]（1個）
   - 說明：添加了工時計算
   
4. 幻覺分數：25分（輕微幻覺：包含少量額外數據）
```

### 實例4：中度幻覺（50分）

```
應回答之詞彙：「煙火管制區需要轄區指派人員核准」

RAG回答：「進入煙火管制區需要轄區指派人員核准，
         申請時間為3個工作天，核准有效期限為7天，
         每日最多允許5組人員同時作業」

計算過程：
1. 參考元素：
   - 專有名詞：["煙火管制區", "轄區指派人員"]
   
2. 回答元素：
   - 專有名詞：["煙火管制區", "轄區指派人員"]
   - 數字：["3", "7", "5"]
   - 額外內容：申請時間、有效期限、人員限制
   
3. 比對結果：
   - 額外數字：["3", "7", "5"]（3個）
   - 虛構內容：多項未提及的具體規定
   
4. 幻覺分數：50分（中度幻覺：包含多個未提及的具體數據）
```

### 實例5：嚴重幻覺（100分）

```
應回答之詞彙：「工作許可證申請需要包商名稱」

RAG回答：「根據公司規定，工作許可證申請需要包商名稱、
         統一編號、負責人身分證字號、公司地址、
         資本額至少500萬元、ISO認證證書，
         並需繳交保證金10萬元」

計算過程：
1. 參考元素：
   - 專有名詞：["工作許可證", "包商名稱"]
   
2. 回答元素：
   - 大量額外要求：統編、身分證、地址、資本額、ISO、保證金
   - 額外數字：["500", "10"]
   - 額外詞彙比例：> 80%
   
3. 比對結果：
   - 大量虛構的具體要求
   - 完全超出原始資訊範圍
   
4. 幻覺分數：100分（嚴重幻覺：大量虛構內容）
```

## 四、特殊情況處理

### 1. 同義詞處理

```python
同義詞對照 = {
    "包商": ["承包商", "廠商", "承攬商"],
    "核准": ["批准", "同意", "許可"],
    "時段": ["時間", "期間", "時程"]
}

# 處理時將同義詞視為相同
```

### 2. 格式差異處理

```
原文：「08:00～17:00」
回答1：「8:00-17:00」    → 視為相同，不算幻覺
回答2：「早上8點到下午5點」→ 視為相同，不算幻覺
回答3：「8AM到5PM」      → 視為相同，不算幻覺
```

### 3. 合理推論判定

```
原文：「施工轄區」
回答：「施工轄區（即施工所在的管轄區域）」
判定：合理解釋，極輕微幻覺（10分）

原文：「工作許可證」
回答：「工作許可證是進行特殊作業的必要文件」
判定：合理補充說明，極輕微幻覺（10分）
```

## 五、評分要點總結

1. **優先檢查具體數據**：數字、日期、金額等
2. **區分解釋與虛構**：合理解釋給予較低分數
3. **考慮實務情況**：格式轉換不算幻覺
4. **累積效應**：多個小幻覺可能升級為中度幻覺
5. **上下文理解**：根據問題判斷回答的合理範圍

## 六、調整建議

根據實際應用場景，可以調整：
- **嚴格模式**：任何額外內容都視為幻覺
- **寬鬆模式**：允許更多解釋性內容
- **自定義規則**：特定領域的專業判斷