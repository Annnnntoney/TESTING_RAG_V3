# RAG 評估系統 v2.0 使用指南

## 🎯 快速開始指南

### 第一步：安裝相依套件

```bash
# 基礎套件（必裝）
pip install pandas numpy jieba streamlit plotly openpyxl xlsxwriter

# 語義相似度套件（推薦）
pip install sentence-transformers torch

# 或一次安裝全部
pip install -r requirements_v2.txt
```

### 第二步：啟動儀表板

```bash
streamlit run streamlit_dashboard_v2_with_manual_gpt.py
```

瀏覽器會自動開啟 `http://localhost:8501`

---

## 📊 三層評估架構說明

### 第一層：關鍵詞匹配（自動）
- **功能**: 計算回答中包含的關鍵詞比例
- **速度**: 極快（<1秒/題）
- **適用**: 快速篩選、基礎評估

### 第二層：語義相似度（自動，推薦）
- **功能**: 計算回答與參考答案的語義相似度
- **速度**: 中等（1-2秒/題）
- **適用**: 捕捉語義層面的匹配度

### 第三層：GPT 人工評審（人工，深度）
- **功能**: 多維度深度分析（相關性、完整性、準確性、忠實度）
- **成本**: 完全免費（使用 ChatGPT 免費版）
- **適用**: 深度分析、質化研究

---

## 🚀 完整操作流程

### 步驟 1: 準備資料檔案

您的 Excel/CSV 檔案需要包含以下欄位：

| 欄位名稱 | 範例 |
|---------|------|
| 序號 | 1, 2, 3, ... |
| 測試問題 | 「請問工作許可證的申請流程為何？」 |
| 應回答之詞彙 | 「工作許可證、申請流程、包商名稱」 |
| 向量知識庫（原始版） | 原始版本的 AI 回答 |
| 智慧文檔知識庫（彙整版） | 優化版本的 AI 回答 |

**範例資料**:
```
序號,測試問題,應回答之詞彙,向量知識庫（原始版）,智慧文檔知識庫（彙整版）
1,請問工作許可證的申請流程為何？,工作許可證、申請流程、包商名稱、施工轄區,需要向工安部門申請工作許可證...,工作許可證的申請流程包括：1. 填寫申請表...
```

### 步驟 2: 上傳檔案並配置評估

1. **選擇檔案來源**
   - 📂 **本地資料夾**: 從 `test_data/` 資料夾選擇
   - 📤 **上傳檔案**: 直接上傳 Excel/CSV

2. **配置評估層級**
   - ✅ **關鍵詞匹配**: 預設啟用（必選）
   - ✅ **語義相似度**: 推薦啟用
   - ✅ **GPT 人工評審**: 建議啟用（免費）

3. **調整評分權重**
   - 系統會自動建議權重
   - 您也可以手動調整滑桿

### 步驟 3: 查看自動評估結果

點擊「📊 評估總覽」查看：
- 📈 綜合評分對比
- 🎯 關鍵詞覆蓋率
- 🔤 語義相似度
- 📊 改善統計

### 步驟 4: 進行 GPT 人工評審（可選）

**4.1 進入 GPT 評審頁籤**
點擊「🤖 GPT 人工評審」

**4.2 選擇要評審的問題**
從下拉選單選擇問題

**4.3 複製 Prompt 到 ChatGPT**
- 點擊「🔴 原始版本」區域
- 複製生成的 Prompt
- 貼到 ChatGPT（免費版即可）

**4.4 貼回 ChatGPT 的回應**
- ChatGPT 會返回 JSON 格式的評分
- 複製整個 JSON
- 貼到「📥 貼上 ChatGPT 的 JSON 回應」區域
- 點擊「✅ 確認並儲存評分」

**4.5 重複評審優化版本**
- 點擊「🟢 優化版本」區域
- 重複步驟 4.3-4.4

**4.6 查看即時更新的結果**
- 返回「📊 評估總覽」
- 所有指標已自動更新，包含 GPT 評分！

### 步驟 5: 查看完整分析

**📈 詳細對比**
- 查看三層評估的詳細對比表格
- 雷達圖展示多維度評估結果

**💬 問題導覽**
- 瀏覽每個問題的詳細評分
- 篩選顯示特定類型的問題
  - 顯著改善
  - 略有改善
  - 效果退步
  - 已有 GPT 評分
  - 未有 GPT 評分

### 步驟 6: 匯出結果

**📥 下載結果頁籤**
- **完整評估報告（Excel）**: 包含所有評估資料和 GPT 評分
- **GPT 評分摘要（JSON）**: 僅匯出 GPT 評分數據

---

## 💡 最佳實踐

### 評估策略建議

#### 場景 1: 快速評估（10-20 分鐘）
```
✅ 關鍵詞匹配
✅ 語義相似度
❌ GPT 評審
```
- 適用：日常評估、快速檢查
- 速度：極快
- 成本：免費

#### 場景 2: 標準評估（30-60 分鐘）【推薦】
```
✅ 關鍵詞匹配
✅ 語義相似度
✅ GPT 評審（抽樣 20-30%）
```
- 適用：大多數評估場景
- 速度：中等
- 成本：免費（使用 ChatGPT 免費版）

#### 場景 3: 深度分析（1-2 小時）
```
✅ 關鍵詞匹配
✅ 語義相似度
✅ GPT 評審（全部問題）
```
- 適用：重要項目、研究分析
- 速度：較慢（需人工操作）
- 成本：免費

### GPT 評審技巧

1. **批次評審效率**
   - 建議一次評審 5-10 題
   - 可以在不同時段分批完成
   - 系統會自動儲存進度

2. **ChatGPT 使用建議**
   - 使用 GPT-3.5（免費版）即可
   - 確保複製完整的 JSON 回應
   - 如果 JSON 格式錯誤，重新請 ChatGPT 生成

3. **優先評審問題**
   - 先評審「效果退步」的問題
   - 再評審「略有改善」的問題
   - 最後評審「顯著改善」的問題作為驗證

### 權重配置建議

| 場景 | 關鍵詞權重 | 語義權重 | GPT 權重 | 說明 |
|------|-----------|---------|---------|------|
| 資訊完整性優先 | 0.6 | 0.3 | 0.1 | 強調關鍵詞覆蓋 |
| 平衡評估（推薦） | 0.3 | 0.3 | 0.4 | 三層平衡 |
| 品質深度優先 | 0.2 | 0.3 | 0.5 | 強調 GPT 評審 |
| 無 GPT 評審 | 0.5 | 0.5 | 0.0 | 僅使用自動評估 |

---

## 🔧 常見問題

### Q1: 語義相似度一直顯示 0？

**A**: 檢查是否安裝 `sentence-transformers`:
```bash
pip install sentence-transformers torch
```

首次使用會自動下載模型（約 400MB），請耐心等待。

### Q2: 如何解讀 GPT 評分？

**A**: GPT 評分包含四個維度：
- **相關性 (Relevance)**: 回答是否切題
- **完整性 (Completeness)**: 是否包含所有關鍵資訊
- **準確性 (Accuracy)**: 資訊是否正確
- **忠實度 (Faithfulness)**: 是否基於原始資料

綜合評分 = 四個維度的平均分

### Q3: ChatGPT 返回的不是 JSON 格式怎麼辦？

**A**: 在 ChatGPT 中輸入：
```
請以 JSON 格式重新輸出評分結果
```

或者重新貼一次 Prompt。

### Q4: 如何清除已儲存的 GPT 評分？

**A**: 在「🤖 GPT 人工評審」頁籤底部，點擊「🔄 清除所有 GPT 評分」按鈕。

### Q5: 可以只評審部分問題嗎？

**A**: 可以！系統支援部分評審。未評審的問題 GPT 權重會自動設為 0。

### Q6: GPT 評分會影響綜合評分嗎？

**A**: 會的。綜合評分 = 關鍵詞分數 × 關鍵詞權重 + 語義分數 × 語義權重 + GPT 分數 × GPT 權重

如果您沒有評審某題，該題的 GPT 分數為 0。

### Q7: 如何匯入之前儲存的 GPT 評分？

**A**: 目前暫不支援匯入。建議在單次 session 中完成評審，或使用「下載結果」功能儲存完整報告。

### Q8: 忠誠度下降是不是不好？

**A**: 不一定！適度的忠誠度下降可能表示：
- 回答更完整（包含更多解釋）
- 回答更易懂（添加必要的補充）

應該綜合考慮其他指標（相關性、完整性、準確性）。

---

## 📊 輸出結果說明

### Excel 報告欄位說明

**基本資訊**:
- `序號`, `測試問題`, `應回答之詞彙`

**原始版本評分**:
- `KEYWORD_COVERAGE_ORIGINAL`: 關鍵詞覆蓋率 (%)
- `SEMANTIC_SIMILARITY_ORIGINAL`: 語義相似度 (%)
- `GPT_OVERALL_ORIGINAL`: GPT 綜合評分 (0-100)
- `GPT_RELEVANCE_ORIGINAL`: GPT 相關性分數
- `GPT_COMPLETENESS_ORIGINAL`: GPT 完整性分數
- `GPT_ACCURACY_ORIGINAL`: GPT 準確性分數
- `GPT_FAITHFULNESS_ORIGINAL`: GPT 忠實度分數
- `FINAL_SCORE_ORIGINAL`: 綜合評分（根據權重計算）

**優化版本評分**:
- 同上，但後綴為 `_OPTIMIZED`

**改善分析**:
- `KEYWORD_IMPROVEMENT`: 關鍵詞改善幅度 (%)
- `SEMANTIC_IMPROVEMENT`: 語義改善幅度 (%)
- `GPT_IMPROVEMENT`: GPT 評分改善
- `FINAL_IMPROVEMENT`: 綜合改善幅度

---

## 🎓 進階技巧

### 自訂同義詞字典

編輯 `rag_evaluation_two_models_v2.py` 中的 `_is_similar_term` 方法：

```python
def _is_similar_term(self, keyword: str, answer: str) -> bool:
    """檢查是否有相似詞彙"""
    synonyms = {
        "包商": ["承包商", "廠商", "承攬商"],
        "負責人": ["主管", "管理人", "聯絡人"],
        # 新增您的同義詞
        "系統": ["平台", "應用程式", "軟體"],
        "文件": ["檔案", "資料", "記錄"],
    }
    # ... 其餘程式碼
```

### 批次處理多個檔案

```python
import os
from rag_evaluation_two_models_v2 import RAGEvaluatorV2

data_folder = 'test_data'
for filename in os.listdir(data_folder):
    if filename.endswith('.xlsx'):
        evaluator = RAGEvaluatorV2(
            os.path.join(data_folder, filename),
            enable_semantic=True
        )
        results = evaluator.evaluate_all()
        evaluator.save_results(f'results_{filename}')
```

### 自動化 GPT Prompt 生成

使用 `gpt_manual_evaluation_helper.py`:

```python
from gpt_manual_evaluation_helper import GPTManualEvaluationHelper

helper = GPTManualEvaluationHelper('test_data/測試資料.xlsx')

# 生成所有 prompts 到檔案
helper.save_prompts_to_file(version="optimized")

# 建立回應輸入模板
helper.create_response_template()
```

---

## 📞 技術支援

- **問題回報**: 請聯繫技術團隊
- **功能建議**: 歡迎提供改進建議
- **使用諮詢**: 請參考本文件或範例資料

---

## 🎉 版本歷史

### v2.0 (2024)
- ✨ 新增三層評估架構
- ✨ 新增語義相似度評估
- ✨ 新增 GPT 人工評審功能
- ✨ 零 API 成本設計
- ✨ 所有指標同時呈現
- ✨ 即時更新評估結果

### v1.0 (2024)
- 基礎關鍵詞匹配評估
- 忠誠度評估
- Streamlit 儀表板

---

**版本**: 2.0
**最後更新**: 2024年
**作者**: AI 知識庫優化團隊

---

## 📸 介面截圖說明

### 主介面
- 左側邊欄：檔案上傳、評估配置、權重設定
- 主區域：五個頁籤（評估總覽、GPT 人工評審、詳細對比、問題導覽、下載結果）

### GPT 評審介面
- 左右分欄：原始版本 vs 優化版本
- 每欄包含：
  - 查看回答
  - GPT Prompt（可複製）
  - 回應貼上區
  - 已儲存的評分顯示

### 評估總覽介面
- 四個關鍵指標卡片
- 評估配置顯示
- 改善統計
- 分數分布圖表

---

祝您使用愉快！🎉
